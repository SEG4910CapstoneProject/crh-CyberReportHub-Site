<div class="favourites-page-container" [class.dark-mode]="isDarkMode()">
  <div class="header">
    <h1>{{
      'fav.urfav' | translate
    }}</h1>
    <button class="add-tag-btn" (click)="openCreateTagDialog()">+ {{
      'fav.addtag' | translate
    }}</button>
  </div>

  <!-- Loading Spinner -->
  <crh-progress-spinner *ngIf="isLoading"></crh-progress-spinner>

  <!-- Logged-in view -->
  <div *ngIf="!isLoading && isLoggedIn()" class="sections">

    <!-- Show only if there are untagged favourites -->
    <div class="category-section" *ngIf="(untaggedFavourites?.length || 0) > 0">
      <h2 (click)="toggleSection('general')" class="collapsible-header">
        {{
          'fav.articles' | translate
        }}
        <span class="arrow">
          {{ collapsedSections['general'] ? '►' : '▼' }}
        </span>
      </h2>

      <div *ngIf="!collapsedSections['general']">
        <ul class="article-list">
          <li *ngFor="let article of untaggedFavourites" class="article-item">
            <a
              [href]="article.link"
              target="_blank"
              class="article-link"
              (click)="incrementViewCount(article.articleId)">
              <h3>{{ article.title }}</h3>
            </a>
            <p class="article-description">
              {{ article.description || 'No description available.' }}
            </p>
            <p><strong>{{
              'articles.pub' | translate
            }}</strong> {{ article.publishDate || 'N/A' }}</p>

            <span
              class="star-icon"
              (click)="toggleFavourite(article)"
              [class.fav]="isFavourite(article)">
              &#9733;
            </span>
          </li>
        </ul>
      </div>
    </div>

    <!-- Tagged sections -->
    <div class="category-section" *ngFor="let tag of userTags">
      <h2 class="collapsible-header tag-header" (click)="toggleSection('tag-' + tag.tagId)">
        <div class="tag-info">
          <span class="tag-name">{{ tag.tagName }}</span>
          <span class="tag-actions" (click)="$event.stopPropagation()">
        <span class="edit-icon" (click)="openEditTagDialog(tag)">✏️Edit</span>
        <span class="delete-icon" (click)="deleteTag(tag)">Delete</span>
      </span>
        </div>
        <span class="arrow">
      {{ collapsedSections['tag-' + tag.tagId] ? '►' : '▼' }}
    </span>
      </h2>

      <div *ngIf="!collapsedSections['tag-' + tag.tagId]">
        <ul class="article-list">
          <li *ngFor="let article of taggedArticles[tag.tagId]" class="article-item">
            <a
              [href]="article.link"
              target="_blank"
              class="article-link"
              (click)="incrementViewCount(article.articleId)">
              <h3>{{ article.title }}</h3>
            </a>
            <p class="article-description">
              {{ article.description || 'No description available.' }}
            </p>
            <p><strong>{{
              'articles.pub' | translate
            }}</strong> {{ article.publishDate || 'N/A' }}</p>

            <span
              class="star-icon"
              (click)="toggleFavourite(article)"
              [class.fav]="isFavourite(article)">
          &#9733;
        </span>
          </li>
        </ul>
      </div>
    </div>


    <!-- Manually added articles -->
    <div class="category-section" *ngIf="(submittedArticles?.length || 0) > 0">
      <h2 (click)="toggleSection('manual')" class="collapsible-header">
        {{
          'fav.manadded' | translate
        }}
        <span class="arrow">
          {{ collapsedSections['manual'] ? '►' : '▼' }}
        </span>
      </h2>

      <div *ngIf="!collapsedSections['manual']">
        <ul class="article-list">
          <li *ngFor="let article of submittedArticles" class="article-item">
            <a
              [href]="article.link"
              target="_blank"
              class="article-link"
              (click)="incrementViewCount(article.articleId)">
              <h3>{{ article.title }}</h3>
            </a>
            <p class="article-description">
              {{ article.description || 'No description available.' }}
            </p>
            <p><strong>{{
              'articles.pub' | translate
            }}</strong> {{ article.publishDate || 'N/A' }}</p>

            <span
              class="star-icon"
              (click)="toggleFavourite(article)"
              [class.fav]="isFavourite(article)">
              &#9733;
            </span>

            <button class="edit-btn" (click)="openEditArticleDialog(article)">✏️ {{
              'fav.edit' | translate
            }}</button>
            <button class="delete-btn" (click)="deleteArticle(article.articleId)">
              {{
                'fav.delete' | translate
              }}
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Logged-out view -->
  <div *ngIf="!isLoggedIn() && !isLoading">
    <p>{{
      'fav.login' | translate
    }}</p>
  </div>
</div>
